<?xml version="1.0" encoding="iso-8859-1"?>
<!--
	Please see the LICENSE.txt file included with this distribution for
	attribution and copyright information.
-->
<root version="3.0">
	<windowclass name="speed_window">
		<frame>utilitybox</frame>
		<placement>
			<size width="330" height="220" />
		</placement>
		<sizelimits >
			<maximum width="450" height="300" />
			<minimum width="263" height="175" />
			<dynamic />
		</sizelimits>
		<sheetdata>
			<windowtitlebar_utilitybox name="title">
				<resource>speed_title</resource>
			</windowtitlebar_utilitybox>
			<windowmenubar_utilitybox name="windowmenubar_utilitybox" />
			<anchor_content_utilitybox_top />
			<anchor_content_utilitybox_bottom />
			<area_content_framed_groupbox name="contentframe" />
			<subwindow name="speedwindowcontent">
				<anchored to="contentframe" position="over" />
				<class>speed_window_content</class>
				<activate />
			</subwindow>
			<resize_utilitybox />
		</sheetdata>
	</windowclass>
	<windowclass name="speed_window_content">
		<sheetdata>
			<anchor_content_top />
			<string_content_noframe_static_top name="actorname">
				<center />
			</string_content_noframe_static_top>
			<stringc_content_noframe_noscroll_static_top>
				<center />
				<static textres="speed_title" />
			</stringc_content_noframe_noscroll_static_top>
			<string_content_noframe_static_top name="currentSpeed">
				<center />
			</string_content_noframe_static_top>
		</sheetdata>
	</windowclass>

	<windowclass name="ct_section_active" merge="join">
		<sheetdata>
			<string_ct name="speed" merge="delete" />
			<string_ct name="WalkThisWay.currentSpeed">
				<anchored to="speedlabel" position="righthigh" offset="5,0" height="20">
<!--					<right parent="anchor_section" offset="-15" /> -->
					<right parent="anchor_section" />
				</anchored>
				<script>
					function onDoubleClick()
						local nodeW = window.getDatabaseNode();
						WalkThisWay.openSpeedWindow(nodeW);
					end
				</script>
				<readonly />
			</string_ct>
		</sheetdata>
	</windowclass>
	<windowclass name="ct_section_active_npc" merge="join">
		<sheetdata>
			<string_ct name="speed" merge="delete" />
			<string_ct name="WalkThisWay.currentSpeed">
				<anchored to="speedlabel" position="righthigh" offset="5,0" height="20">
<!--					<right parent="anchor_section" offset="-15" /> -->
					<right parent="anchor_section" />
				</anchored>
				<script>
					function onDoubleClick()
						local nodeW = window.getDatabaseNode();
						WalkThisWay.openSpeedWindow(nodeW);
					end
				</script>
				<readonly />
			</string_ct>
		</sheetdata>
	</windowclass>
	<windowclass name="charsheet_sensescombat" merge="join">
		<sheetdata>
			<number_charspeed name="speed" source="WalkThisWay.base">
				<script>
					function onDoubleClick()
						local nodeW = window.getDatabaseNode();
						local nodeCT = ActorManager.getCTNodeName(nodeW);
						WalkThisWay.openSpeedWindow(nodeCT);
					end
				</script>
			</number_charspeed>
		</sheetdata>
	</windowclass>
	<windowclass name="npc_combat_top_2024" merge="join">
		<sheetdata>
			<string_content_column name="speed" merge="join">
				<script>
					function onDoubleClick()
						local nodeW = window.getDatabaseNode();
						local nodePath = DB.getPath(nodeW);
						if string.match(nodePath, 'combattracker') then
							WalkThisWay.openSpeedWindow(nodeW);
						end
					end
				</script>			
			</string_content_column>
		</sheetdata>
	</windowclass>
	<windowclass name="npc_combat_top_2014" merge="join">
		<sheetdata>
			<string_content_column name="speed" merge="join">
				<script>
					function onDoubleClick()
						local nodeW = window.getDatabaseNode();
						local nodePath = DB.getPath(nodeW);
						if string.match(nodePath, 'combattracker') then
							WalkThisWay.openSpeedWindow(nodeW);
						end
					end
				</script>			
			</string_content_column>
		</sheetdata>
	</windowclass>
	<template name = "wtw_green_light">
		<stringcontrol name="value">
			<anchored width="35" height ="25">
				<top anchor="top"/>
				<left anchor="right"/>
			</anchored>	
			<center />
			<readonly />
			<font>reference-h</font>
			<script>		
				local sDBPath = nil
				local sLabel = nil
				local sAnchor = nil
				local sAbility = nil
				
				function onInit()					
					sDBPath = self.getName()			
					sAnchor = "speed"	
					assignAnchor(sAnchor)	
					refresh()
				end
				function assignAnchor(sAnchor)
					setAnchor("top", sAnchor, "top")
					setAnchor("left", sAnchor, "right","",-10)
				end	
				function onValueChanged()
					refresh()
				end
				function refresh()					
					local nodeChar = window.getDatabaseNode()					

					--ADDED BY FARRATTO
					local nValue = nil
					local nBaseValue = nil
					--if WalkThisWay then
						local nodeCharWtW = DB.getChild(nodeChar, 'WalkThisWay')
						if nodeCharWtW then
							nBaseValue = DB.getValue(nodeCharWtW, 'base')
							nValue = DB.getValue(nodeCharWtW, 'bonus')
						end
					--end
					--if not nBaseValue or not nValue then
					--	--ORIGINAL CODE MOVED BY FARRATTO
					--	local nodeSpeed = DB.getChild(nodeChar,"speed")
					--	nBaseValue = DB.getValue(nodeSpeed,"total")
					--	local nodeCharExt = DB.getChild(nodeChar,"MNMCharacterSheetEffectsDisplay")
					--	nValue = DB.getValue(nodeCharExt,sDBPath)
					--	--END ORGINAL CODE MOVED BY FARRATTO
					--end
					--END ADDED BY FARRATTO
					
					if nValue &gt; 0 then
						setFrame("fieldgreen")
						setVisible(true)
					elseif nValue &lt; 0 then
						setFrame("fieldred")
						setVisible(true)					
					else
						setVisible(false)
					end		
									
					setValue(nBaseValue + nValue)				
				end		
			</script>								
		</stringcontrol>	
	</template>
	<windowclass name="charsheet_sensescombat" merge="join">	
		<sheetdata>
			<wtw_green_light name = "WalkThisWay.bonus"/>
		</sheetdata>		
	</windowclass>		
	<template name = "MNMBONUSSPEED" merge="join">
		<stringcontrol name="value">
			<invisible/>
			<script merge="replace">		
				function onInit()					
					setVisible(false)
					sAnchor = "speed"	
					assignAnchor(sAnchor)	
				end
				function assignAnchor(sAnchor)
					setAnchor("top", sAnchor, "top")
					setAnchor("left", sAnchor, "right","",-10)
				end	
				function refresh()					
					setVisible(false)
				end		
			</script>								
		</stringcontrol>	
	</template>
</root>
